# Infrastructure Deployment with Terraform

Design and deploy modular, cost-aware infrastructure for the Movie Analyst application using Terraform. Ensure reproducibility, environment separation, remote state management, and audit-ready governance.

---

## 1. Modular Architecture

Reusable Terraform modules:

### `network/`
- VPC
- Public and private subnets
- Route tables
- NAT Gateway (optional for private egress)
- Subnet strategy:
  - QA â†’ single AZ (`us-east-1a`)
  - Prod â†’ multi-AZ (`us-east-1a`, `us-east-1b`)

### `bastion/`
- EC2 instance with **SSM-only access**
- IAM instance profile with `AmazonSSMManagedInstanceCore`
- Security group with **no ingress rules**
- No SSH key, no port 22

### `frontend/` and `backend/`
- EC2 instances for UI and API
- Independent security groups
- User data for provisioning
- **SSM-only access**, no SSH
- Security groups use **SG-to-SG references**, no CIDRs

### `loadbalancer/`
- Application Load Balancer (ALB)
- Target group and listener
- Security group defined inside module

### `database/`
- RDS MySQL instance
- Security group allows MySQL access **only from backend SG**
- Subnet group uses **single AZ in QA**, multi-AZ in production

### `iam/`
- IAM role for EC2 instances
- CloudWatch Agent policy (optional)
- SSM access role and instance profile
- Outputs: `ssm_instance_profile_name`, `ssm_role_name`

All modules include governance tags:

```hcl
tags = {
  Project     = "terraform-ansible-aws"
  Environment = "qa" or "prod"
  Owner       = "felipe"
  CostCenter  = "lab"
  Tier        = "low-cost"
}
```

---

## 2. Environment Separation with Workspaces

Use Terraform Workspaces to isolate QA and Production environments:

```bash
terraform workspace new qa
terraform workspace new prod
```

Each environment has its own folder:
```bash
terraform/environments/qa/
terraform/environments/prod/
```

---

## 3. Remote Backend Configuration

Configure remote state storage using S3 and DynamoDB for locking:

### `backend.tf` (inside each environment folder)
```hcl
terraform {
  backend "s3" {
    bucket         = "terraform-state-bucket-felipe-99009900"
    key            = "env/${terraform.workspace}/terraform.tfstate"
    region         = "us-east-1"
    dynamodb_table = "terraform-locks-felipe-99009900"
    encrypt        = true
  }
}
```

> DynamoDB table must be created manually or via `state_backend` module.

---

## 54. Deployment Validation

Run the following commands per environment:

```bash
cd projects/terraform-ansible-aws/terraform/environments/qa # or prod
terraform workspace new qa
terraform workspace select qa
terraform init
terraform validate
terraform plan
terraform apply
terraform output -json > outputs.json
mv outputs.json ../../../ansible/outputs.json
```

Then validate SSM access:

```bash
aws ssm describe-instance-information
aws ssm start-session --target <instance-id>
```

> Confirm bastion, frontend, and backend are SSM-managed and accessible without SSH.

---

> This removes all provisioned infrastructure while preserving the remote state file for audit history.

---

## ðŸ“Œ Notes

- All EC2 modules use **SSM-only access**, no SSH
- Security groups use **explicit SG references**, no CIDRs
- QA uses **single AZ**, production uses **multi-AZ**
- IAM roles and instance profiles are consolidated and reusable
- Tags support cost allocation and resource tracking
- Outputs feed directly into Ansible inventory and provisioning routines
```
